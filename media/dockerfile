# 使用 NVIDIA 官方预构建的 FFmpeg 镜像
FROM nvidia/cuda:12.6.1-base-ubuntu22.04

# 设置环境变量
ENV DEBIAN_FRONTEND=noninteractive \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8

# 安装系统依赖
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    ffmpeg \
    ffprobe \
    python3-pip \
    python3-dev \
    libsm6 \
    libxext6 \
    libgl1-mesa-glx \
    curl \
    wget \
    git \
    && rm -rf /var/lib/apt/lists/*

# 创建应用程序目录
RUN mkdir -p /app
WORKDIR /app

# 复制应用文件
COPY requirements.txt .
COPY app.py .
COPY common.py .
COPY image_processor.py .
COPY video_processor.py .
COPY entrypoint.sh .

# 安装 Python 依赖
RUN pip3 install --no-cache-dir -r requirements.txt

# 设置权限
RUN chmod +x entrypoint.sh

# 创建非 root 用户
RUN useradd -m appuser
USER appuser

# 暴露端口
EXPOSE $PORT

# 设置入口点
ENTRYPOINT ["./entrypoint.sh"]